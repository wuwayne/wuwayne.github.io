---

layout: post

title:  "python异步IO编程"

date:   2017-2-17 09:05:22 +0800

categories:  python

tags:   IO 异步 异步IO

---

### 什么是异步IO

在一个线程中，CPU执行代码的速度极快，然而，一旦遇到IO操作，如读写文件、发送网络数据时，就需要等待IO操作完成，才能继续进行下一步操作。这种情况称为同步IO。

相反，CPU不需要等待IO操作完成就继续执行下一步操作就是异步IO。

### 同步与异步

同步和异步关注的是消息的通信机制

- 所谓同步，就是在发出一个*调用*时，没得到结果之前，该*调用*就不返回。但是一旦调用返回就得到返回值了，*调用者*主动等待这个*调用*的结果

- 所谓异步，就是在发出一个*调用*时，这个*调用*就直接返回了，不管返回有没有结果。当一个异步过程调用发出后，*被调用者*通过状态，通知来通知*调用者*，或者通过回调函数处理这个调用

### 异步与多进（线）程

协程的最大的特点在于是一个线程执行的，所以在python中有2个大的优势

1. 执行效率高。因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销，和多线程比，线程数量越多，协程的性能优势就越明显。

2. 不存在GIL，因为只有一个线程，也不存在同时写变量冲突。

因为协程是一个线程执行，那怎么利用多核CPU呢？最简单的方法是多进程+协程，既充分利用多核，又充分发挥协程的高效率，可获得极高的性能。

Python对协程的支持是通过generator实现的。


### 为什么需要异步IO

因为CPU的速度远远快于磁盘、网络等IO，CPU高速执行能力和IO设备的龟速严重不匹配。

多线程和多进程的并发也可以解决此类问题，但是系统不能无上限地增加线程。而且系统切换线程的开销也很大，所以，一旦线程数量过多，CPU的时间就花在线程切换上了，真正运行代码的时间就少了，结果导致性能严重下降。


### 阻塞与非阻塞

阻塞和非阻塞关注的是程序在等待的结果时的状态

- 阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才返回

- 非阻塞调用是指在不能立即得到结果之前，该调用不会阻塞当前线程


### 举例

老张爱喝茶，废话不说，煮开水。

出场人物：老张，水壶两把（普通水壶，简称水壶；会响的水壶，简称响水壶）。

1. 老张把水壶放到火上，立等水开。（同步阻塞）
老张觉得自己有点傻

2. 老张把水壶放到火上，去客厅看电视，时不时去厨房看看水开没有。（同步非阻塞）
老张还是觉得自己有点傻，于是变高端了，买了把会响笛的那种水壶。水开之后，能大声发出嘀的噪音。

3. 老张把响水壶放到火上，立等水开。（异步阻塞）
老张觉得这样傻等意义不大

4. 老张把响水壶放到火上，去客厅看电视，水壶响之前不再去看它了，响了再去拿壶。（异步非阻塞）
老张觉得自己聪明了。

所谓同步异步，只是对于水壶而言。
普通水壶，同步；响水壶，异步。
虽然都能干活，但响水壶可以在自己完工之后，提示老张水开了。这是普通水壶所不能及的。
同步只能让调用者去轮询自己（情况2中），造成老张效率的低下。

所谓阻塞非阻塞，仅仅对于老张而言。
立等的老张，阻塞；看电视的老张，非阻塞。
情况1和情况3中老张就是阻塞的，媳妇喊他都不知道。虽然3中响水壶是异步的，可对于立等的老张没有太大的意义。所以一般异步是配合非阻塞使用的，这样才能发挥异步的效用。


### 异步IO实战

